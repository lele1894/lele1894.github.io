name: Update YouTube Trending

on:
  workflow_dispatch: # 支持手动触发
    inputs:
      api_key:
        description: 'YouTube API Key'
        required: true
        type: string
  schedule:
    - cron: '0 */4 * * *'  # 每4小时运行一次：0:00, 4:00, 8:00, 12:00, 16:00, 20:00

jobs:
  update-trending:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write  # 添加 actions 权限

    steps:
      - uses: actions/checkout@v3  # 更新到 v3

      - name: Set up Python
        uses: actions/setup-python@v4  # 更新到 v4
        with:
          python-version: '3.10'  # 更新 Python 版本

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client translators jinja2 tzdata

      - name: Debug Environment Variables
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "API key (secrets): ${{ secrets.YOUTUBE_API_KEY }}"
          echo "API key (input): ${{ github.event.inputs.api_key }}"
          echo "Current UTC time: $(date -u)"
          echo "Current local time: $(date)"

      - name: Debug Workflow
        run: |
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "Current UTC time: $(date -u)"
          echo "Current Asia/Shanghai time: $(TZ='Asia/Shanghai' date)"
          echo "GitHub context: ${{ toJSON(github) }}"

      - name: Run trending script
        env:
          YOUTUBE_API_KEY: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.api_key || secrets.YOUTUBE_API_KEY }}
          TZ: 'Asia/Shanghai'  # 设置时区
        run: |
          python main.py

      - name: Commit and push if changed
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add us.html hk.html tw.html index.html
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          git commit -m "Update trending videos at ${timestamp}" || exit 0
          git push
